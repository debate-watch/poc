<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Debate Watch</title>
  <link rel="stylesheet" href="bower_components/octicons/octicons/octicons.css">
  <link rel="stylesheet" href="bower_components/jquery.ui/themes/base/core.css">
  <link rel="stylesheet" href="bower_components/jquery.ui/themes/base/slider.css">
  <link rel="stylesheet" href="bower_components/jquery.ui/themes/base/theme.css">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <style type="text/css">
      body { padding-top: 60px; }
      nav {height: 60px; }
      /* .navigation .octicon { width: 64px;} */
      div#page {width: 940px;}
      div#player {display:inline-block}
      div#slider {display:inline-block; height: 360px; margin-left:1em;}
      div#timeline {margin-top:1em; margin-bottom:1em;}
      footer{margin-top: 1em; margin-bottom: 2em;}
  </style>
</head>
<body>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#"><span class="mega-octicon octicon-podium"></span></a>
    </div>
  </nav>

  <div id="page" class="container">
    <div class="page-header">
      <h1 id="event-title">Iowa Republican Lincoln Dinner <small id="event-date">May 10, 2015</small></h1>
    </div>

    <div id="player-container">
      <div class="row">
        <div id="player">Loading the player ...</div>
        <div id="slider"></div>
      </div>
      <div class="row">
        <div id="timeline"></div>
      </div>
    </div>
  </div>

  <footer class="container">
    <hr>
    <a href="https://github.com/debate-watch/poc">source</a>
  </footer>

  <script src="bower_components/d3/d3.min.js" charset="utf-8"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/jquery.ui/ui/core.js"></script>
  <script src="bower_components/jquery.ui/ui/widget.js"></script>
  <script src="bower_components/jquery.ui/ui/mouse.js"></script>
  <script src="bower_components/jquery.ui/ui/slider.js"></script>
  <script type="text/javascript">

      // PLAYER

      var player;

      var player_options = {
          file_name: '/videos/IowaRepublicanLincolnDinner_400771_3.mp4',
          image_name: '/images/IowaRepublicanLincolnDinner_400771.png',
          height: 360,
          width: 640,
          starting_position: 0
      };

      var player_position = player_options.starting_position;

      var timeline = d3.select("div#timeline").append("svg")
          .attr("height", 36)
          .attr("width", player_options.width)
          .attr("style", "border:1px solid #ccc; background:#eee;")

      var player_position_reference_line = timeline.append("svg:line")
          .attr("x1", player_position)
          .attr("y1", 0)
          .attr("x2", player_position)
          .attr("y2", 100)
          .attr("fill","none")
          .attr("stroke","steelblue")
          .attr("stroke-width","2px")

      var positionToWidth = d3.scale.linear()
          .range([0, player_options.width]);

      var rating_options = {"min": -50, "max": 50, "step":1, "neutral": 0};

      var ratings_slider = $("#slider")
          .slider({
              orientation:"vertical",
              min: rating_options.min,
              max: rating_options.max,
              step: rating_options.step,
              value: rating_options.neutral
          })
          .on("slidechange", function(e,ui){
              if (e.originalEvent) {
                  var player_position = player.getPosition();
                  var rating_value = ratings_slider.slider("value");

                  positioned_ratings.push([player_position,rating_value])

                  ratings_slider.slider("option","value", rating_options.neutral);
              }
          });

      //var ratings = [];
      //var ratings = [[1.9,22],[4.1,25],[5.9,41],[6.9,23],[7.2,23],[7.4,23],[7.7,23],[7.9,23],[8.4,23],[8.4,23],[9.2,33],[9.4,33],[10.2,34],[10.7,42],[10.7,42],[11.7,-22],[11.9,-22],[12.4,-29],[12.7,-29],[12.9,-29],[13.2,-29],[13.7,-37],[13.9,-37],[15.5,22],[15.9,7],[16.9,-9]]

      //function logRating(){ // slider.getRating
      //    var position = player.getPosition();
      //    var rating = ratings_slider.slider("value");
      //    ratings.push([position,rating])
      //    console.log(position, rating);
      //    console.log(ratings)
      //};

      //function resetRating(){
      //    ratings_slider.slider("option","value", rating_options.neutral);
      //};

      var positioned_ratings = []

      d3.json("api_keys.json", function(json){
          var jwplayer_source_url = "http://jwpsrv.com/library/" + json["jwplayer"] + ".js"
          $.getScript(jwplayer_source_url, function( data, textStatus, jqxhr ) {

              player = jwplayer('player')
                  .setup({
                      file: player_options.file_name,
                      image: player_options.image_name,
                      height: player_options.height,
                      width: player_options.width
                  })
                  .onTime(function(e){

                      player_position = e.position // this.getPosition();
                      var video_duration = e.duration // this.getDuration(); // #todo: find a way to avoid setting this every iteration of onTime
                      var rating_value = ratings_slider.slider("value");

                      // update rating

                      var positioned_rating = {
                        "position": player_position,
                        "completion_percentage": (player_position / video_duration * 100).toFixed(5),
                        "rating_value": rating_value
                      }
                      console.log(positioned_rating)

                      // validate uniqueness of position, and set the non-neutral rating

                      positioned_ratings.push([positioned_rating["position"], positioned_rating["rating_value"]])
                      // see positions 5.5, 6.1, 22.9, 23.9 >> [[0,0],[0.3,0],[0.5,0],[0.8,0],[1,0],[1.3,0],[1.5,0],[1.8,0],[2,0],[2.3,0],[2.5,0],[2.8,0],[3,0],[3.3,0],[3.5,0],[3.8,0],[4,0],[4.3,0],[4.5,0],[4.8,0],[5.1,0],[5.3,0],[5.5,20],[5.5,20],[5.5,20],[5.5,20],[6.1,20],[6.1,20],[6.1,20],[6.1,20],[6.6,20],[6.6,20],[6.6,20],[6.8,0],[6.8,20],[7,0],[7,20],[7.3,20],[7.3,20],[7.3,20],[7.6,0],[7.6,20],[7.8,20],[7.8,20],[7.8,20],[8.1,0],[8.3,0],[8.6,0],[8.8,0],[9.1,0],[9.3,0],[9.6,0],[9.8,0],[10.1,0],[10.3,-28],[10.3,-28],[10.3,-28],[10.6,0],[10.6,-28],[10.8,-28],[10.8,-28],[11.1,0],[11.1,-28],[11.3,0],[11.3,-28],[11.6,0],[11.8,0],[12.1,0],[12.3,0],[12.6,0],[12.6,0],[12.8,0],[12.8,0],[13.1,0],[13.1,0],[13.3,0],[13.6,0],[13.8,0],[14.1,-29],[14.1,-29],[14.3,0],[14.6,0],[14.8,0],[15.1,0],[15.3,0],[15.6,0],[15.8,0],[16.3,0],[16.6,0],[16.8,0],[16.8,-26],[17.1,0],[17.3,0],[17.6,0],[17.8,0],[18.1,0],[18.4,-48],[18.4,-48],[18.6,0],[18.8,0],[19.1,0],[19.4,-4],[19.6,-49],[19.9,-50],[20.1,-50],[20.1,-50],[20.4,0],[20.6,0],[20.9,0],[21.1,0],[21.4,40],[21.6,42],[21.9,50],[21.9,50],[22.1,0],[22.4,0],[22.6,0],[22.9,49],[22.9,49],[23.1,0],[23.4,0],[23.6,0],[23.9,0],[24.1,0],[24.4,0],[24.6,0],[24.9,0],[25.1,0],[25.4,0],[25.6,0],[25.9,0],[26.1,0]]

                      var ratings_by_position = d3.nest()
                          .key(function(d){ return d[0]; })
                          .entries(positioned_ratings)
                      //var duplicates = ratings_by_position.filter(function(d){ return d.values.length > 1; })
                      // 132 pairs >> [{"key":"34","values":[[34,0],[34,-42]]},{"key":"35","values":[[35,0],[35,-45]]},{"key":"36","values":[[36,0],[36,-45]]},{"key":"37","values":[[37,0],[37,-45]]},{"key":"4.4","values":[[4.4,-28],[4.4,-28]]},{"key":"6.4","values":[[6.4,-12],[6.4,-12]]},{"key":"7.1","values":[[7.1,-17],[7.1,-17]]},{"key":"7.9","values":[[7.9,-32],[7.9,-32]]},{"key":"8.9","values":[[8.9,0],[8.9,-31]]},{"key":"9.4","values":[[9.4,0],[9.4,-41]]},{"key":"9.9","values":[[9.9,-47],[9.9,-47]]},{"key":"10.4","values":[[10.4,-35],[10.4,-35]]},{"key":"10.9","values":[[10.9,0],[10.9,5]]},{"key":"11.4","values":[[11.4,16],[11.4,16]]},{"key":"11.6","values":[[11.6,0],[11.6,24]]},{"key":"12.2","values":[[12.2,0],[12.2,30]]},{"key":"13.2","values":[[13.2,0],[13.2,36]]},{"key":"13.7","values":[[13.7,0],[13.7,40]]},{"key":"14.9","values":[[14.9,31],[14.9,31]]},{"key":"15.4","values":[[15.4,31],[15.4,31]]},{"key":"15.9","values":[[15.9,21],[15.9,21]]},{"key":"16.4","values":[[16.4,-16],[16.4,-16]]},{"key":"16.9","values":[[16.9,0],[16.9,-29]]},{"key":"17.4","values":[[17.4,0],[17.4,-43]]},{"key":"18.4","values":[[18.4,0],[18.4,46]]},{"key":"19.4","values":[[19.4,36],[19.4,36]]},{"key":"19.9","values":[[19.9,0],[19.9,22]]},{"key":"34.5","values":[[34.5,0],[34.5,-45]]},{"key":"34.8","values":[[34.8,0],[34.8,-45]]},{"key":"35.3","values":[[35.3,0],[35.3,-45]]},{"key":"35.5","values":[[35.5,0],[35.5,-45]]},{"key":"35.8","values":[[35.8,0],[35.8,-45]]},{"key":"36.3","values":[[36.3,0],[36.3,-45]]},{"key":"36.5","values":[[36.5,0],[36.5,-45]]},{"key":"37.3","values":[[37.3,-45],[37.3,-45]]},{"key":"37.5","values":[[37.5,-45],[37.5,-45]]},{"key":"37.8","values":[[37.8,-45],[37.8,-45]]}]"
                      var scrubbed_prs = ratings_by_position.map(function(nst){
                          var selected_rating_value;
                          var non_neautrals = nst.values.filter(function(pair){ return pair[1] != rating_options.neutral; })

                          if(nst.values.length > 1 && non_neautrals.length > 1){
                              selected_rating_value = non_neautrals[0][1] // the rating value of the first non-neutral pair
                          } else {
                              selected_rating_value = nst.values[0][1] // the rating value of the first pair
                          };

                          return [nst.key, selected_rating_value]
                      })

                      console.log(scrubbed_prs)
                      // 102 pairs >> [["0",0],["1",0],["2",0],["3",0],["4",0],["7",0],["0.3",0],["0.5",0],["0.8",0],["1.3",0],["1.5",0],["1.8",0],["2.3",0],["2.5",0],["2.8",0],["3.3",0],["3.5",0],["3.8",0],["4.3",0],["4.5",0],["4.8",0],["5.1",0],["5.3",0],["5.5",20],["6.1",20],["6.6",20],["6.8",0],["7.3",20],["7.6",0],["7.8",20],["8.1",0],["8.3",0],["8.6",0],["8.8",0],["9.1",0],["9.3",0],["9.6",0],["9.8",0],["10.1",0],["10.3",-28],["10.6",0],["10.8",-28],["11.1",0],["11.3",0],["11.6",0],["11.8",0],["12.1",0],["12.3",0],["12.6",0],["12.8",0],["13.1",0],["13.3",0],["13.6",0],["13.8",0],["14.1",-29],["14.3",0],["14.6",0],["14.8",0],["15.1",0],["15.3",0],["15.6",0],["15.8",0],["16.3",0],["16.6",0],["16.8",0],["17.1",0],["17.3",0],["17.6",0],["17.8",0],["18.1",0],["18.4",-48],["18.6",0],["18.8",0],["19.1",0],["19.4",-4],["19.6",-49],["19.9",-50],["20.1",-50],["20.4",0],["20.6",0],["20.9",0],["21.1",0],["21.4",40],["21.6",42],["21.9",50],["22.1",0],["22.4",0],["22.6",0],["22.9",49],["23.1",0],["23.4",0],["23.6",0],["23.9",0],["24.1",0],["24.4",0],["24.6",0],["24.9",0],["25.1",0],["25.4",0],["25.6",0],["25.9",0],["26.1",0]]"

                      // update lines

                      positionToWidth.domain([0, video_duration]); // #todo: find a way to avoid setting this every iteration of onTime

                      player_position_reference_line.transition()
                          .attr("x1", positionToWidth(player_position))
                          .attr("x2", positionToWidth(player_position));

                      // update ratings line given the positioned_ratings array. do the scale conversions within ____

                      // todo

                  })

              play()

          });

      });

      function play(){
          jwplayer('player').play(true)
      };

      function pause(){
          jwplayer('player').play(false)
      };

      function stop(){
          jwplayer('player').stop()
      };

  </script>
</body>
</html>
