<html>
<head>
  <title>Debate Watch</title>
  <link rel="stylesheet" href="bower_components/octicons/octicons/octicons.css">
  <link rel="stylesheet" href="bower_components/jquery.ui/themes/base/core.css">
  <link rel="stylesheet" href="bower_components/jquery.ui/themes/base/slider.css">
  <link rel="stylesheet" href="bower_components/jquery.ui/themes/base/theme.css">
  <link rel="stylesheet" href="bower_components/jquery-ui-slider-pips/dist/jquery-ui-slider-pips.css">
  <link rel="stylesheet" href="bower_components/circular-slider/dist/circular-slider.min.css">
  <style type="text/css">
      //#vertical-slider {
      //    height: 150px;
      //    margin-left: 30px;
      //}

      //.ui-slider-pip-selected {
      //    color:steelblue;
      //}

      //.ui-state-focus {
      //    left:100;
      //    color:steelblue;
      //}

      //.ui-state-active {
      //    left:100;
      //    color:steelblue;
      //}
  </style>
</head>
<body>
  <div id="nav">
    <h1><span class="mega-octicon octicon-podium"></span>&nbsp;Debate Watch</h1>
  </div>
  <div id="page">
    <h2 id="event-title">Iowa Republican Lincoln Dinner</h2>
    <div id="player">Loading the player ...</div>
    <div id="timeline" style="display:inline-block; margin-top:1em; margin-bottom:1em;"></div>
    <div id="feedback">
      <div class="btn-group" role="group" style="margin-bottom:1em;">
        <button type="button" class="btn btn-default feedback-button" value="-1">-</button>
        <button type="button" class="btn btn-default feedback-button" value="1">+</button>
      </div>
      <div class="btn-group" role="group" style="margin-bottom:1em;">
        <button type="button" class="btn btn-default feedback-button" value="-5">-5</button>
        <button type="button" class="btn btn-default feedback-button" value="-3">-3</button>
        <button type="button" class="btn btn-default feedback-button" value="-1">-1</button>
        <button type="button" class="btn btn-default feedback-button" value="1">+1</button>
        <button type="button" class="btn btn-default feedback-button" value="3">+3</button>
        <button type="button" class="btn btn-default feedback-button" value="5">+5</button>
      </div>
      <div id="slider-h" class="slider" style="margin-top:1em; margin-bottom:2em; width:320px;"></div>
      <div id="slider-v" class="slider" style="margin-top:2em; margin-bottom:2em; height:320px;"></div>
      <div id="slider-c" style="margin-top:2em; margin-bottom:2em; height:160px;"></div>
    </div>
  </div>
  <div id="footer">
    <a href="https://github.com/debate-watch/poc">source</a>
  </div>
  <script src="bower_components/d3/d3.min.js" charset="utf-8"></script>

  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/jquery.ui/ui/core.js"></script>
  <script src="bower_components/jquery.ui/ui/widget.js"></script>
  <script src="bower_components/jquery.ui/ui/mouse.js"></script>
  <script src="bower_components/jquery.ui/ui/slider.js"></script>
  <script src="bower_components/jquery-ui-slider-pips/dist/jquery-ui-slider-pips.min.js"></script>
  <script src="bower_components/circular-slider/dist/circular-slider.min.js"></script>
  <script type="text/javascript">

      var current_position = 0; // workaround to set initial value before player starts playing.

      var player_width = 640;

      var durationScale = d3.scale.linear()
          .range([0, player_width]);

      var timeline = d3.select("div#timeline").append("svg")
          .attr("height",36)
          .attr("width",player_width)
          .attr("style","border:1px solid #ccc; background:#eee;")

      var current_position_reference_line = timeline.append("svg:line")
          .attr("x1",current_position).attr("y1",0)
          .attr("x2",current_position).attr("y2",100)
          .attr("fill","none")
          .attr("stroke","steelblue")
          .attr("stroke-width","1.5px")

      // PLAYER

      d3.json("api_keys.json", function(json){

          var jwplayer_source_url = "http://jwpsrv.com/library/" + json["jwplayer"] + ".js"

          $.getScript(jwplayer_source_url, function( data, textStatus, jqxhr ) {

              jwplayer('player').setup({
                  file: '/videos/IowaRepublicanLincolnDinner_400771_3.mp4',
                  image: '/images/IowaRepublicanLincolnDinner_400771.png',
                  height: 360,
                  width: player_width
              })

              jwplayer('player').onTime(function(){

                  // update durationScale based on video duration.

                  var video_duration = this.getDuration(); // #todo: find a way to avoid setting this every iteration of onTime

                  durationScale.domain([0, video_duration]); // #todo: find a way to avoid setting this every iteration of onTime

                  // update current position and reference line based on scaled current position.

                  current_position = this.getPosition();

                  current_position_reference_line.transition()
                      .attr("x1", durationScale(current_position))
                      .attr("x2", durationScale(current_position));

                  var current_progress = current_position / video_duration;
                  var current_progress_percentage = (current_progress * 100).toFixed(5)

                  console.log("POSITION (s):", current_position, "-- COMPLETION (%):", current_progress_percentage); // console.log("STATE:", this.getState()) // this will always log "PLAYING" under the .onTime() function. Time doesn't move when the player is paused.
              });

              play()

          });

      });

      function play(){
          jwplayer('player').play(true)
      };

      function pause(){
          jwplayer('player').play(false)
      };

      function stop(){
          jwplayer('player').stop()
      };

      // FEEDBACK

      var feedback_values = {"min": -50, "max": 50, "neutral": 0, "tick_interval": 10 };

      // FEEDBACK > BUTTONS

      var feedback_buttons = document.getElementsByClassName("feedback-button")

      for (var i=0; i < feedback_buttons.length; i++){
        feedback_buttons[i].addEventListener("click", clickFeedback, false);
      }

      function clickFeedback(){
          var feedback_value = parseInt(this.value);
          console.log(feedback_value);
      };

      // FEEDBACK > SLIDER

      $("#slider-v").slider({
          orientation:"vertical",
          min: feedback_values.min,
          max: feedback_values.max,
          step: feedback_values.tick_interval,
          value: feedback_values.neutral
      });

      $("#slider-h").slider({
          orientation:"horizontal",
          min: feedback_values.min,
          max: feedback_values.max,
          step: feedback_values.tick_interval,
          value: feedback_values.neutral
      });

      var slider_display_options = {
          //rest:"label",
          formatLabel: function(val){
              if(val > 0){ return this.prefix + "+" + val + this.suffix } else { return this.prefix + val + this.suffix }
          }
      };

      $(".slider").slider()
          .slider('pips', slider_display_options)
          .slider('float', slider_display_options);

      $(".slider").on("slidechange", function(event,ui){

          if (event.originalEvent) { // avoids infinite loop...

              var feedback_value = $(this).slider("value");
              console.log(feedback_value);

              $(".slider").slider("option","value", feedback_values.neutral);
          };
      });

      // FEEDBACK > CIRCULAR SLIDER (DIAL)

      var dial = $('#slider-c').CircularSlider({
          min: feedback_values.min,
          max: feedback_values.max,
          value: feedback_values.neutral,
          shape: "Half Circle",
          radius: 75,
          innerCircleRatio: '0.70',
          //handleDist: 100,
          animate: true,
          animateDuration : 300,
          selectable: false,
          //formLabel: function(value, prefix, suffix){},
          onSlideEnd: function(ui, val) {
              var feedback_value = val;
              console.log(feedback_value);

              dial.setValue(feedback_values.neutral);
          }
      });

  </script>
</body>
</html>
